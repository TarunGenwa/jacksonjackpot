// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  username  String   @unique
  firstName String?
  lastName  String?
  password  String
  isActive  Boolean  @default(true)
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  wallet       Wallet?
  tickets      Ticket[]
  transactions Transaction[]
  winners      Winner[]

  @@map("users")
}

model Charity {
  id          String   @id @default(uuid())
  name        String
  description String
  logoUrl     String?
  website     String?
  email       String
  phone       String?
  address     String?
  isVerified  Boolean  @default(false)
  isActive    Boolean  @default(true)
  taxId       String?  @unique
  bankDetails Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  competitions Competition[]
  donations    Donation[]

  @@map("charities")
}

model Competition {
  id                String             @id @default(uuid())
  title             String
  description       String
  type              CompetitionType    @default(MYSTERYBOXES)
  charityId         String
  startDate         DateTime
  endDate           DateTime
  drawDate          DateTime
  ticketPrice       Decimal            @db.Decimal(10, 2)
  totalPrizeValue   Decimal            @default(0) @db.Decimal(10, 2)
  maxTickets        Int
  ticketsSold       Int                @default(0)
  minTickets        Int                @default(1)
  status            CompetitionStatus  @default(DRAFT)
  isActive          Boolean            @default(true)
  imageUrl          String?
  termsAndConditions String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  charity      Charity      @relation(fields: [charityId], references: [id])
  prizes       Prize[]
  tickets      Ticket[]
  winners      Winner[]
  instantWins  InstantWin[]
  drawSeed     DrawSeed?

  @@index([status, isActive])
  @@index([charityId])
  @@index([type])
  @@map("competitions")
}

model Prize {
  id            String      @id @default(uuid())
  competitionId String
  name          String
  description   String
  value         Decimal     @db.Decimal(10, 2)
  position      Int
  imageUrl      String?
  quantity      Int         @default(1)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  competition Competition  @relation(fields: [competitionId], references: [id])
  winners     Winner[]
  instantWins InstantWin[]

  @@unique([competitionId, position])
  @@map("prizes")
}

model Wallet {
  id        String   @id @default(uuid())
  userId    String   @unique
  balance   Decimal  @default(0) @db.Decimal(10, 2)
  currency  String   @default("GBP")
  isLocked  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id])
  transactions Transaction[]

  @@map("wallets")
}

model Transaction {
  id              String            @id @default(uuid())
  walletId        String
  userId          String
  type            TransactionType
  status          TransactionStatus @default(PENDING)
  amount          Decimal           @db.Decimal(10, 2)
  currency        String            @default("GBP")
  description     String?
  referenceId     String?           @unique
  paymentMethod   String?
  paymentProvider String?
  metadata        Json?
  processedAt     DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  wallet Wallet @relation(fields: [walletId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@index([userId, status])
  @@index([walletId])
  @@map("transactions")
}

model Ticket {
  id            String       @id @default(uuid())
  ticketNumber  String       @unique
  competitionId String
  userId        String
  purchasePrice Decimal      @db.Decimal(10, 2)
  status        TicketStatus @default(ACTIVE)
  chainEntryId  String?      @unique
  purchasedAt   DateTime     @default(now())
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  competition Competition @relation(fields: [competitionId], references: [id])
  user        User        @relation(fields: [userId], references: [id])
  winner      Winner?
  chainEntry  HashChain?  @relation(fields: [chainEntryId], references: [id])

  @@index([competitionId, status])
  @@index([userId])
  @@map("tickets")
}

model Winner {
  id            String       @id @default(uuid())
  competitionId String
  userId        String
  ticketId      String       @unique
  prizeId       String
  status        WinnerStatus @default(PENDING)
  claimedAt     DateTime?
  paidOutAt     DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  competition Competition @relation(fields: [competitionId], references: [id])
  user        User        @relation(fields: [userId], references: [id])
  ticket      Ticket      @relation(fields: [ticketId], references: [id])
  prize       Prize       @relation(fields: [prizeId], references: [id])

  @@index([competitionId])
  @@index([userId])
  @@map("winners")
}

model Donation {
  id        String         @id @default(uuid())
  charityId String
  amount    Decimal        @db.Decimal(10, 2)
  currency  String         @default("GBP")
  donorName String?
  donorEmail String?
  status    DonationStatus @default(PENDING)
  message   String?
  isAnonymous Boolean      @default(false)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  charity Charity @relation(fields: [charityId], references: [id])

  @@index([charityId, status])
  @@map("donations")
}

model HashChain {
  id           String          @id @default(uuid())
  sequence     Int             @unique
  type         ChainEntryType
  timestamp    DateTime        @default(now())
  data         Json
  metadata     Json?
  previousHash String?
  hash         String          @unique
  createdAt    DateTime        @default(now())

  ticket       Ticket?
  instantWin   InstantWin?

  @@index([sequence])
  @@index([type])
  @@index([timestamp])
  @@map("hash_chain")
}

model ChainCheckpoint {
  id                 String   @id @default(uuid())
  sequence           Int      @unique
  hash               String
  merkleRoot         String
  entriesCount       Int
  startSequence      Int
  endSequence        Int
  publishedHash      String?
  publishedTimestamp DateTime?
  createdAt          DateTime @default(now())

  @@index([sequence])
  @@map("chain_checkpoints")
}

model InstantWin {
  id            String           @id @default(uuid())
  competitionId String
  prizeId       String
  position      Int
  encryptedData String
  isRevealed    Boolean          @default(false)
  isClaimed     Boolean          @default(false)
  claimedByTicketId String?      @unique
  chainEntryId  String?          @unique
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  competition Competition  @relation(fields: [competitionId], references: [id])
  prize       Prize        @relation(fields: [prizeId], references: [id])
  chainEntry  HashChain?   @relation(fields: [chainEntryId], references: [id])

  @@unique([competitionId, position])
  @@index([competitionId, isClaimed])
  @@map("instant_wins")
}

model DrawSeed {
  id            String       @id @default(uuid())
  competitionId String       @unique
  seedCommit    String
  seedReveal    String?
  commitTimestamp DateTime
  revealTimestamp DateTime?
  status        DrawSeedStatus @default(COMMITTED)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  competition Competition @relation(fields: [competitionId], references: [id])

  @@map("draw_seeds")
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum CompetitionType {
  MYSTERYBOXES
  INSTANT_WINS
  DAILY_FREE
  INSTANT_SPINS
}

enum CompetitionStatus {
  DRAFT
  UPCOMING
  ACTIVE
  SOLD_OUT
  DRAWING
  COMPLETED
  CANCELLED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  TICKET_PURCHASE
  PRIZE_PAYOUT
  REFUND
  BONUS
  FEE
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum TicketStatus {
  ACTIVE
  WINNER
  EXPIRED
  CANCELLED
  REFUNDED
}

enum WinnerStatus {
  PENDING
  NOTIFIED
  CLAIMED
  PAID
  EXPIRED
}

enum DonationStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum ChainEntryType {
  TICKET_PURCHASE
  PRIZE_ALLOCATION
  DRAW_RESULT
  PRIZE_CLAIM
  COMPETITION_STATE_CHANGE
  INSTANT_WIN_REVEAL
  SEED_COMMIT
  SEED_REVEAL
  CHECKPOINT
}

enum DrawSeedStatus {
  COMMITTED
  REVEALED
  USED
}